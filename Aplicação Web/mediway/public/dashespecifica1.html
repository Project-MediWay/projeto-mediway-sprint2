  <!DOCTYPE html>
  <html lang="pt-br">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="styles/dashespecifica.css" />
  </head>

  <body>
    <!-- Inicio estruturação Modal -->
    <div class="overlay-user" id="overlayUser" onclick="esconderModal()">
    </div>
    <div class="user-menu" id="userMenu">
      <div class="titulo-user-menu">
        <img src="assets/dashboard/user.png" height="70px">
        <span id="modal_nome_empresa"></span>
      </div>

      <div class="info-user-menu">
        <span class="nome-user" id="modal_nome_usuario"></span>
        <span class="email-user" id="modal_email_usuario"></span>
      </div>

      <div class="btn-sair-user-menu">
        <a href="login.html">Sair</a>
      </div>
    </div>
    <!-- Término estruturação Modal -->


    <!-- Inicio estruturação do corpo da dasboard -->
    <div class="main">

      <!-- Inicio estruturação Barra de Título -->
      <div class="title">
        <img src="assets/dashboard/voltar.png" height="40px" class="btn-voltar" onclick="voltar()">
        <span class="title-main">Monitoramento de Veículo: <p id="placa"></p></span>
        <img src="assets/dashboard/user.png" onclick="exibirModal()" class="user" />
      </div>
      <!-- Término estruturação Barra de Título -->


      <!-- Inicio estruturação das KPIS -->
      <div class="kpis">
        <div class="metrica">
          <span class="valor-kpis"> Ideal:</span>
          <span class="valor-kpis">2°C - 8°C</span>
        </div>
        <div class="total-alertas">
          <span class="valor-kpis" id="totalAlertas"></span>
          <span class="texto-kpis">Total de Alertas</span>
          <span class="texto-kpis-menor">(Últimas 4 Horas)</span>
        </div>
        <div class="kpi_vermelha" id="tempAtual">
          <span class="valor-kpis" id="temperaturaAtual"></span>
          <span class="texto-kpis">Temperatura atual</span>
        </div>
        <div class="kpi_vermelha">
          <span class="valor-kpis" id="temperaturaMinima"></span>
          <span class="texto-kpis">Temperatura Mínima</span>
          <span class="texto-kpis-menor">(Últimas 4 Horas)</span>
        </div>
        <div class=" temperatura-maxima">
          <span class="valor-kpis" id="temperaturaMaxima"></span>
          <span class="texto-kpis">Temperatura Máxima</span>
          <span class="texto-kpis-menor">(Últimas 4 Horas)</span>
        </div>
      </div>
      <!-- Término estruturação das KPIS -->


      <!-- Inicio estruturação dos cards de informação e gráficos -->
      <div class="graficos">
        <div class="grafico_metrica">

          <div class="imagem_metrica">
            <img src="assets/imagens/kpi metrica.png" alt="">
          </div>
          <div class="grafico-temperatura">
            <canvas id="grafico_temperatura"></canvas>
          </div>


        </div>

        <div class="grafico-alerta">
          <div class="dados-semanais">
            <h3>Indicadores dos Últimos 7 Dias</h3>
            <div class="graficos-kpis-semanais">

              <div class="grafico-semanal">
                <canvas id="grafico_alerta_semanal"></canvas>
              </div>

              <div class="kpi-semanal">
                <div class="kpi-semanal-minimo">
                  <span class="texto-kpi-alertas valor-kpis" id="temperaturaMinimaSem"></span>
                  <span class="texto-kpi-alertas">Temperatura Mínima</span>
                </div>
                <div class="kpi-semanal-maximo">
                  <span class="texto-kpi-alertas valor-kpis" id="temperaturaMaximaSem"></span>
                  <span class="texto-kpi-alertas">Temperatura Máxima</span>
                </div>
              </div>
            </div>
          </div>
          <div class="dados-mensais">
            <h3>Indicadores do Último Mês</h3>
            <div class="graficos-kpis-mensais">

              <div class="grafico-mensal">
                <canvas id="grafico_alerta_mensal"></canvas>
              </div>
              <div class="kpi-mensal">
                <div class="kpi-mensal-minimo">
                  <span class="texto-kpi-alertas valor-kpis" id="temperaturaMinimaMen"></span>
                  <span class="texto-kpi-alertas">Temperatura Mínima</span>
                </div>
                <div class="kpi-mensal-maximo">
                  <span class="texto-kpi-alertas valor-kpis" id="temperaturaMaximaMen"></span>
                  <span class="texto-kpi-alertas">Temperatura Máxima</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Término estruturação dos cards de informação -->


    </div>
    <!-- Término estruturação do corpo da dashboard -->
  </body>

  </html>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>

    var kpiAtual = document.getElementById("tempAtual");

    
    // Inicio configuração Modal
    overlayUser.style.display = 'none';
    userMenu.style.display = 'none';

    function exibirModal() {
      overlayUser.style.display = 'block';
      userMenu.style.display = 'flex';
    }

    function esconderModal() {
      overlayUser.style.display = 'none';
      userMenu.style.display = 'none';
    }

    function exibirNoModal() {
    document.getElementById("modal_nome_empresa").innerHTML = sessionStorage.NOME_EMPRESA
    document.getElementById("modal_nome_usuario").innerHTML = `Nome: ${sessionStorage.NOME_USUARIO}`
    document.getElementById("modal_email_usuario").innerHTML = `Email: ${sessionStorage.EMAIL_USUARIO}`
    }
  exibirNoModal()
    // Término configuração Modal


    // Inicio configuração Botão Voltar
    function voltar() {
      window.location.href = 'dashgeral.html'
    }
    // Término configuração Botão Voltar

    function obterPlaca() {
      var veiculo = sessionStorage.ID_VEICULO;
      var Placa = document.getElementById('placa');
      fetch(`/veiculo/obterPlaca/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].Placa_Veiculo)
              Placa.innerHTML = `
        ${respostaConversao[0].Placa_Veiculo}
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }

    function alertasEspec() {
      var veiculo = sessionStorage.ID_VEICULO;
      var Alerta = document.getElementById('totalAlertas');
      fetch(`/veiculo/alertasEspec/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].total_alertas_4h)
              Alerta.innerHTML = `
        ${respostaConversao[0].total_alertas_4h}
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }


    function tempAtual() {
      var veiculo = sessionStorage.ID_VEICULO;
      var temperAtual = document.getElementById('temperaturaAtual');
      var corKPI = document.getElementById('tempAtual');
      fetch(`/veiculo/tempAtual/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].temperatura_atual)
              if(respostaConversao[0].temperatura_atual < 2 || respostaConversao[0].temperatura_atual > 8 ){
                corKPI.classList.add('kpi_vermelha')
                corKPI.classList.remove('kpi_azul')
                corKPI.classList.remove('kpi_amarela')

              } else if (respostaConversao[0].temperatura_atual == 2 || respostaConversao[0].temperatura_atual == 8 ){
                corKPI.classList.add('kpi_amarela')
                corKPI.classList.remove('kpi_azul')
                corKPI.classList.remove('kpi_vermelha')
              } else {
                corKPI.classList.add('kpi_azul')
                corKPI.classList.remove('kpi_vermelha')
                corKPI.classList.remove('kpi_amarela')
                
              }
              temperAtual.innerHTML = `
        ${respostaConversao[0].temperatura_atual}°C
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }

    function tempMin() {
      var veiculo = sessionStorage.ID_VEICULO;
      var tempMinima = document.getElementById('temperaturaMinima');
      fetch(`/veiculo/tempMin/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].temp_min_4h)
              tempMinima.innerHTML = `
        ${respostaConversao[0].temp_min_4h}°C
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }

    function tempMinSem() {
      var veiculo = sessionStorage.ID_VEICULO;
      var tempMinima = document.getElementById('temperaturaMinimaSem');
      fetch(`/veiculo/tempMinSem/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].temp_min_4h)
              tempMinima.innerHTML = `
        ${respostaConversao[0].temp_min_semana}°C
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }

    function tempMaxSem() {
      var veiculo = sessionStorage.ID_VEICULO;
      var tempMaxima = document.getElementById('temperaturaMaximaSem');
      fetch(`/veiculo/tempMaxSem/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].temp_max_semana)
              tempMaxima.innerHTML = `
        ${respostaConversao[0].temp_max_semana}°C
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }  

    function tempMaxMen() {
      var veiculo = sessionStorage.ID_VEICULO;
      var tempMaxima = document.getElementById('temperaturaMaximaMen');
      fetch(`/veiculo/tempMaxMen/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].temp_max_mes)
              tempMaxima.innerHTML = `
        ${respostaConversao[0].temp_max_mes}°C
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }  

    function tempMinMen() {
      var veiculo = sessionStorage.ID_VEICULO;
      var tempMinima = document.getElementById('temperaturaMinimaMen');
      fetch(`/veiculo/tempMinMen/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].temp_min_mes)
              tempMinima.innerHTML = `
        ${respostaConversao[0].temp_min_mes}°C
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    } 

    function tempMax() {
      var veiculo = sessionStorage.ID_VEICULO;
      var tempMaxima = document.getElementById('temperaturaMaxima');
      fetch(`/veiculo/tempMax/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          resposta.json()
            .then(function (respostaConversao) {
              console.log(respostaConversao[0].temp_max_4h)
              tempMaxima.innerHTML = `
        ${respostaConversao[0].temp_max_4h}°C
        `
            }).catch(function (erroConversao) {
              console.log(erroConversao)
            })
        }).catch(function (erro) {
          console.log(erro)
        })
    }

// 1. Variável global para o gráfico
var graficoGlobal = null;

// 2. Modifique sua função obterGrafico4Horas para salvar o gráfico
function obterGrafico4Horas() {
    var veiculo = sessionStorage.ID_VEICULO;
    var ctx = document.getElementById('grafico_temperatura');

    fetch(`/veiculo/obterGrafico4Horas/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
            return resposta.json();
        })
        .then(function (respostaConversao) {
            console.log('Dados gráfico temperatura:', respostaConversao);

            // Prepara dados
            var labels = [];
            var temperaturas = [];

            for (var i = 0; i < respostaConversao.length; i++) {
                labels.push(respostaConversao[i].hora);
                temperaturas.push(respostaConversao[i].temperatura_atual);
            }

            // Se não tiver dados, usa valores padrão
            if (respostaConversao.length === 0) {
                labels = ['Sem dados'];
                temperaturas = [0];
            }

            // Cria o gráfico e salva na variável global
            graficoGlobal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatura (°C)',
                        data: temperaturas,
                        borderColor: '#0031d0',
                        backgroundColor: 'rgba(0, 49, 208, 0.1)',
                        borderWidth: 3,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Temperatura nas Últimas 4 Horas',
                            color: '#111',
                            font: { size: 18, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // INICIA A ATUALIZAÇÃO AUTOMÁTICA
            iniciarAtualizacaoGrafico();
        })
        .catch(function (erro) {
            console.log('Erro ao carregar gráfico temperatura:', erro);
        });
}

// 3. Função para ATUALIZAR o gráfico automaticamente (SIMPLES!)
function iniciarAtualizacaoGrafico() {
    console.log('Iniciando atualização automática do gráfico...');
    
    // Atualiza a cada 5 segundos
    setInterval(function() {
        if (!graficoGlobal) return;
        
        var veiculo = sessionStorage.ID_VEICULO;
        
        // Busca novos dados
        fetch(`/veiculo/obterGrafico4Horas/${veiculo}`, { 
            cache: "no-store",
            headers: {
                'Cache-Control': 'no-cache'
            }
        })
        .then(function (resposta) {
            return resposta.json();
        })
        .then(function (novosDados) {
            console.log('Atualizando gráfico com', novosDados.length, 'pontos');
            
            // Prepara novos dados
            var labels = [];
            var temperaturas = [];

            for (var i = 0; i < novosDados.length; i++) {
                labels.push(novosDados[i].hora);
                temperaturas.push(novosDados[i].temperatura_atual);
            }

            graficoGlobal.data.labels = labels;
            graficoGlobal.data.datasets[0].data = temperaturas;
            
            // Atualiza o gráfico
            graficoGlobal.update();
        })
        .catch(function (erro) {
            console.log('Erro ao atualizar:', erro);
        });
        
    }, 1000); // 5000ms = 5 segundos
}


    // 2. Função para carregar gráfico semanal (7 dias)
    function obterGrafico7Dias() {
      var veiculo = sessionStorage.ID_VEICULO;
      var ctx = document.getElementById('grafico_alerta_semanal');

      fetch(`/veiculo/obterGrafico7Dias/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
          return resposta.json();
        })
        .then(function (respostaConversao) {
          console.log('Dados gráfico 7 dias:', respostaConversao);

          var labels = [];
          var alertas = [];

          for (var i = 0; i < respostaConversao.length; i++) {
            var data = new Date(respostaConversao[i].data);
            var dataFormatada = data.getDate().toString().padStart(2, '0') + '/' +
              (data.getMonth() + 1).toString().padStart(2, '0');
            labels.push(dataFormatada);
            alertas.push(respostaConversao[i].alertas);
          }

          if (respostaConversao.length === 0) {
            labels = ['Sem dados'];
            alertas = [0];
          }

          
          var myChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Alertas',
                  data: alertas,
                  backgroundColor: '#e70000',
                  borderColor: '#e70000'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: { beginAtZero: true }
                }
              }
            });
        })
        .catch(function (erro) {
          console.log('Erro ao carregar gráfico 7 dias:', erro);
        });
    }

    // 3. Função para carregar gráfico mensal
   function obterGraficoMensal() {
    var veiculo = sessionStorage.ID_VEICULO;
    var ctx = document.getElementById('grafico_alerta_mensal');

    fetch(`/veiculo/obterGraficoMensal/${veiculo}`, { cache: "no-store" })
        .then(function (resposta) {
            return resposta.json();
        })
        .then(function (respostaConversao) {
            console.log('Dados gráfico mensal RAW:', respostaConversao);
        
            var labels = [];
            var alertas = [];

            for (var i = 0; i < respostaConversao.length; i++) {
                // DEBUG: Verifica a estrutura dos dados
                console.log('Item mensal:', respostaConversao[i]);
                
                // Tenta diferentes formatos
                if (respostaConversao[i].semana) {
                    labels.push('Semana ' + respostaConversao[i].semana);
                } else if (respostaConversao[i].mes) {
                    labels.push(respostaConversao[i].mes);
                } else if (respostaConversao[i].periodo) {
                    labels.push(respostaConversao[i].periodo);
                }
                
                
                alertas.push(respostaConversao[i].alertas || respostaConversao[i].total || respostaConversao[i].qtd || 0);
            }
  console.log('Labels mensais:', labels);
            console.log('Alertas mensais:', alertas);

            if (labels.length === 0 || alertas.length === 0) {
                labels = ['Sem dados'];
                alertas = [0];
            }

            // DESTROI gráfico anterior se existir
            if (typeof graficoMensal !== 'undefined' && graficoMensal) {
                graficoMensal.destroy();
            }

            // Cria NOVO gráfico
            graficoMensal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Alertas Semanais',
                        data: alertas,
                        backgroundColor: '#e70000',
                        borderColor: '#e70000',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Alertas - Último Mês',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Alertas'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Período'
                            }
                        }
                    }
                }
            });
        })
        .catch(function (erro) {
            console.log('Erro ao carregar gráfico mensal:', erro);
        });
}

    window.onload = function() {
    obterPlaca()
    alertasEspec()
    tempAtual()
    tempMin()
    tempMax()
    obterGrafico4Horas()
    obterGrafico7Dias()
    obterGraficoMensal()
    tempMaxSem()
    tempMinSem()
    tempMaxMen()
    tempMinMen()
};

    function atualizar(){
      setTimeout(()=>{
        alertasEspec()
        tempAtual()
        tempMin()
        tempMax()
        obterGrafico4Horas()
        obterGrafico7Dias()
        obterGraficoMensal()
        tempMaxSem()
        tempMinSem()
        tempMaxMen()
        tempMinMen()
        atualizar()
    },5000)
  }

  atualizar()

  </script>