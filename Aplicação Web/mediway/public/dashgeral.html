<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <script src="js/sessao.js"></script>
  <link rel="stylesheet" href="styles/dashgeral.css" />
</head>

<body>
  <!-- Inicio estruturação Modal -->
  <div class="overlay-user" id="overlayUser" onclick="esconderModal()">
  </div>
  <div class="user-menu" id="userMenu">
    <div class="titulo-user-menu">
      <img src="assets/dashboard/user.png" height="70px" alt="">
      <span id="modal_nome_empresa"></span>
    </div>

    <div class="info-user-menu">
      <span class="nome-user" id="modal_nome_usuario">Julia Araripe</span>
      <span class="email-user" id="modal_email_usuario">araripe@email.com</span>
    </div>

    <div class="btn-sair-user-menu">
      <a href="login.html" onclick="limparSessao()">Sair</a>
    </div>
  </div>
  <!-- Término estruturação Modal -->

  <!-- Inicio estruturação do corpo da dasboard -->
  <div class="main">
    <div class="title">
      <img src="assets/imagens/footer-img.png" class="logo" />
      <span class="title-main">Monitoramento de Veículos</span>
      <img src="assets/dashboard/user.png" onclick="exibirModal()" class="user" />
    </div>


    <!-- Inicio estruturação das KPIS -->
    <div class="kpis">
      <div class="metrica">
        <span class="texto-kpis" style="font-size: 20px">Ideal:</span>
        <span class="texto-kpis" style="font-size: 30px">2°C - 8°C</span>
      </div>
      <div class="qtd-veiculos">
        <span class="texto-kpis" style="margin-right: 10px">Quantidade de Veículos:</span>
        <span class="texto-kpis" id="qtd_geral"></span>
      </div>
      <div class="qtd-normal">
        <span class="texto-kpis" style="margin-right: 10px">Normal:</span>
        <span class="texto-kpis" id="qtd_normal"></span>
      </div>
      <div class="qtd-no-limite">
        <span class="texto-kpis" style="margin-right: 10px">No limite:</span>
        <span class="texto-kpis" id="qtd_limite"></span>
      </div>
      <div class="qtd-alerta" >
        <span class="texto-kpis" style="margin-right: 10px">Em alerta:</span>
        <span class="texto-kpis"><div id="qtd_alerta"></div></span>
      </div>
    </div>
    <!-- Término estruturação das KPIS -->


    <!-- Inicio estruturação dos cards de informação e gráficos -->
    <div class="informacoes">


      <!-- Inicio estruturação do card de histórico de alertas -->
      <div class="historico">
        <div class="imagem_metrica">
          <img src="assets/imagens/kpi metrica.png" alt="">
        </div>
        <div class="titulo-historico">Histórico de Alertas</div>
        <div class="tabela-historico">
          <table>
            <thead>
              <tr class="cabecalho-tabela">
                <th>Data</th>
                <th>Hora</th>
                <th>Veículo</th>
                <th>Temperatura</th>
              </tr>
            </thead>
            <tbody id="tabela-dados">
              <!-- <tr>
                <td>05/10/2025</td>
                <td>21:05</td>
                <td>VWX1234</td>
                <td>-3°C</td>
              </tr>
              <tr>
                <td>data05/10/2025</td>
                <td>hora21:00</td>
                <td>placa</td>
                <td>temp°C</td>
              </tr>  -->
            </tbody>
          </table>
        </div>
      </div>
      <!-- Término estruturação do card de histórico de alertas -->



      <!-- Inicio estruturação do card de monitoramento dos véiculos -->
      <div class="monitoramento" id="monitoramento">
        <div onclick="ir1()" id="veiculo_1" class="card card-alerta">
          <img class="img-caminhao" src="assets/dashboard/caminhao-atencao.png" />

          <div class="id-caminhao">
            <span class="texto-card texto-placa">Placa:</span>
            <span class="texto-card">VWX1234</span>
          </div>

          <div class="temp-caminhao">
            <span class="texto-card texto-placa">Temperatura:</span>
            <span class="texto-card">-3°C</span>
          </div>

          <div class="status-caminhao">
            <img src="assets/dashboard/atencao.png" class="status-atencao">
            <span class="texto-card texto-placa">Status:&nbsp;</span>
            <span class="texto-card">Alerta</span>
          </div>
        </div>

      </div>
      <!-- Término estruturação do card de monitoramento dos véiculos -->


    </div>
    <!-- Término estruturação dos cards de informação -->


  </div>
  <!-- Término estruturação do corpo da dashboard -->
</body>

</html>
<script>
  // Declaração de variaveis
  var listaVeiculos;
  var listaHistorico;


  // Inicio configuração Modal
  overlayUser.style.display = 'none';
  userMenu.style.display = 'none';
  exibirNoModal();

  function ir(idVeiculo) {
    // Salva o ID na sessão e redireciona
    sessionStorage.ID_VEICULO = idVeiculo;
    window.location.href = 'dashespecifica1.html';
}

  function exibirModal() {
    overlayUser.style.display = 'block';
    userMenu.style.display = 'flex';
  }

  function esconderModal() {
    overlayUser.style.display = 'none';
    userMenu.style.display = 'none';
  }
  // Término configuração Modal


    function exibirNoModal() {
      document.getElementById("modal_nome_empresa").innerHTML = sessionStorage.NOME_EMPRESA
      document.getElementById("modal_nome_usuario").innerHTML = `Nome: ${sessionStorage.NOME_USUARIO}`
      document.getElementById("modal_email_usuario").innerHTML = `Email: ${sessionStorage.EMAIL_USUARIO}`
    }


  function obterVeiculos() {
    var empresa = sessionStorage.ID_EMPRESA;
    fetch(`/veiculo/obterVeiculos/${empresa}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            resposta.reverse();

            listaVeiculos = resposta;

            montarPainelVeiculos();
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }



  function montarPainelVeiculos() {
    let painelVeiculos = document.getElementById("monitoramento")
    let mensagem = ``;

    for (let i = 0; i < listaVeiculos.length; i++) {
      let placa = listaVeiculos[i].placa;
      let temperatura = Number(listaVeiculos[i].temperatura_atual).toFixed();
      let id_veiculo = Number(listaVeiculos[i].idVeiculo);

      if (temperatura < 2 || temperatura > 8) {
        mensagem += `
            <div onclick="ir(${id_veiculo})" id="veiculo_${id_veiculo}" class="card card-alerta">
              <img class="img-caminhao" src="assets/dashboard/caminhao-atencao.png" />
              
              <div class="id-caminhao">
                <span class="texto-card texto-placa">Placa:</span>
                <span class="texto-card">${placa}</span>
              </div>
                
              <div class="temp-caminhao">
                  <span class="texto-card texto-placa">Temperatura:</span>
                  <span class="texto-card">${temperatura}°C</span>
              </div>
                  
              <div class="status-caminhao">
                  <img src="assets/dashboard/atencao.png" class="status-atencao">
                  <span class="texto-card texto-placa">Status:&nbsp;</span>
                  <span class="texto-card">Alerta</span>
              </div>
            </div>
        `
      } else if (temperatura == 8 || temperatura == 2) {
        mensagem += `
            <div onclick="ir(${id_veiculo})" id="veiculo_${id_veiculo}" class="card card-no-limite">
              <img class="img-caminhao" src="assets/dashboard/caminhao-cuidado.png" />
              
              <div class="id-caminhao">
                <span class="texto-card texto-placa">Placa:</span>
                <span class="texto-card">${placa}</span>
              </div>
                
              <div class="temp-caminhao">
                  <span class="texto-card texto-placa">Temperatura:</span>
                  <span class="texto-card">${temperatura}°C</span>
              </div>
                  
              <div class="status-caminhao">
                  <img src="assets/dashboard/cuidado.png" class="status-atencao">
                  <span class="texto-card texto-placa">Status:&nbsp;</span>
                  <span class="texto-card">Atenção</span>
              </div>
            </div>
        `
      } else {
        mensagem += `
            <div onclick="ir(${id_veiculo})" id="veiculo_${id_veiculo}" class="card card-normal">
              <img class="img-caminhao" src="assets/dashboard/caminhao-ok.png" />
              
              <div class="id-caminhao">
                <span class="texto-card texto-placa">Placa:</span>
                <span class="texto-card">${placa}</span>
              </div>
                
              <div class="temp-caminhao">
                  <span class="texto-card texto-placa">Temperatura:</span>
                  <span class="texto-card">${temperatura}°C</span>
              </div>
                  
              <div class="status-caminhao">
                  <img src="assets/dashboard/ok.png" class="status-atencao">
                  <span class="texto-card texto-placa">Status:&nbsp;</span>
                  <span class="texto-card">Normal</span>
              </div>
            </div>
        `
      }

    }

    painelVeiculos.innerHTML = mensagem;
  }

  

    function obterHistorico() {
    var empresa = sessionStorage.ID_EMPRESA;
    fetch(`/veiculo/obterHistorico/${empresa}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            resposta.reverse();

            listaHistorico = resposta;

            montarHistorico();
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  function montarHistorico(){
        let tabela = document.getElementById("tabela-dados")
        let mensagem = ``;

        for(let i = 0; i < listaHistorico.length; i++){
            let data = listaHistorico[i].dtRegistro.slice(0, 10);
            let hora = listaHistorico[i].dtRegistro.slice(11, 19);
            let veiculo = listaHistorico[i].placa;
            let temperatura = listaHistorico[i].temperatura_atual;
            mensagem += `
            <tr>
                <td>${data}</td>
                <td>${hora}</td>
                <td>${veiculo}</td>
                <td>${temperatura}°C</td>
            </tr>`
        }
        tabela.innerHTML = mensagem;
  }

  var empresa = sessionStorage.ID_EMPRESA;
function obterAlertas(){
  var Alerta = document.getElementById('qtd_alerta');
  fetch('/kpi/obterAlertas', {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: 
    JSON.stringify({
      fkempresa: empresa
    })
  })
  .then(function (resposta){
    resposta.json()
    .then(function (respostaConversao){
      Alerta.innerHTML = `
      ${respostaConversao[0].total_alerta}
      `
    }).catch(function (erroConversao){
      console.log(erroConversao)
    })
  }).catch(function (erro){
    console.log(erro)
  })
}

function obterAtencao(){
  var Atencao = document.getElementById('qtd_limite');
  fetch('/kpi/obterAtencao', {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: 
    JSON.stringify({
      fkempresa: empresa
    })
  })
  .then(function (resposta){
    resposta.json()
    .then(function (respostaConversao){
      Atencao.innerHTML = `
      ${respostaConversao[0].total_limite}
      `
    }).catch(function (erroConversao){
      console.log(erroConversao)
    })
  }).catch(function (erro){
    console.log(erro)
  })
}
function obterNormal(){
  var Normal = document.getElementById('qtd_normal');
  fetch('/kpi/obterNormal', {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: 
    JSON.stringify({
      fkempresa: empresa
    })
  })
  .then(function (resposta){
    resposta.json()
    .then(function (respostaConversao){
      Normal.innerHTML = `
      ${respostaConversao[0].total_ideal}
      `
    }).catch(function (erroConversao){
      console.log(erroConversao)
    })
  }).catch(function (erro){
    console.log(erro)
  })
}
function obterQtd(){
  var Geral = document.getElementById('qtd_geral');
  fetch('/kpi/obterQtd', {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: 
    JSON.stringify({
      fkempresa: empresa
    })
  })
  .then(function (resposta){
    resposta.json()
    .then(function (respostaConversao){
      Geral.innerHTML = `
      ${respostaConversao[0].quantidadeVeiculo}
      `
    }).catch(function (erroConversao){
      console.log(erroConversao)
    })
  }).catch(function (erro){
    console.log(erro)
  })
}
  window.onload = 
  validarSessao(),
  obterVeiculos(),
  obterHistorico(),
  obterAlertas(),
  obterAtencao(), 
  obterNormal(), 
  obterQtd()
  
  function atualizar(){
    setTimeout(()=>{
      obterVeiculos(),
      obterHistorico(),
      obterAlertas(),
      obterAtencao(), 
      obterNormal(), 
      obterQtd(),
      console.log('att'),
      atualizar()
    },5000)
  }

  atualizar()
</script>

